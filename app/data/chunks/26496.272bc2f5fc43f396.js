"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[26496],{17423:function(e,n,t){var o=t(80568);t(67294),n.xB=o.cancelKeepAlive,o.createNewRequest,o.delay,n.$g=o.keepAlive},26496:function(e,n,t){t.r(n),t.d(n,{ws:function(){return A}});var o=t(26042),a=t(69396),s=t(67294),i=t(22003),r=t(17423),c=t(6811),l=t(66438),u=t(92927),d=t(72753),v=t(88238),m=t(13290),_=t(12839),f=t(89820),g=t(7997),b=t(20061),h=t(42527),w=t(49906),p=t(83636),k=t(16006),y=t(11163),x=t.n(y),E=t(17450),U=t(4591),T=t(59820),N=t(74939);const Z={},S=!1;let A;const P=(0,s.memo)((e=>{const{onError:n}=e,t=(0,l.xJ)(),{0:o,1:a}=(0,s.useState)((0,m.Hk)());return(0,s.useEffect)((()=>{(0,m.qZ)().then((e=>a(e)));const e=d.U.tokenChanged.subscribe((e=>{o!==e&&a(e||"")}),!0);return()=>{e.unsubscribe(),R()}}),[]),(0,s.useEffect)((()=>{if(!(null===t||void 0===t?void 0:t.user_id)||(0,_.z)()||!o)return;const e=null===A||void 0===A?void 0:A._url;(null===e||void 0===e?void 0:e.includes(o))||V(o,n)}),[null===t||void 0===t?void 0:t.user_id,o,n]),null}));n.default=(0,s.memo)(P);const R=()=>{if((0,r.xB)(),A)try{A.close()}catch(e){console.error(e)}},V=async(e,n)=>{R(),await(0,f.gw)(500);const t=(0,m.ll)(),o="wss://wss.ganjingworld.com/live";A=new i.default(o.includes("token=")?o:"".concat(o,"?token=").concat(e||"","&sid=").concat(t),void 0,{debug:S}),A.onopen=()=>{c.u.onopen.next(!0),(0,r.$g)(A)},A.onerror=e=>{n&&n(e.error||e),c.u.onerror.next(e)},A.onclose=()=>{c.u.onclose.next(!0)},A.onmessage=e=>{try{const t=JSON.parse(e.data)||{},o=t.id;switch(o&&delete Z[o],t.type){case"login":var n;if("facebook"===(null===(n=b.s.getState().account.thirdPartyLogin)||void 0===n?void 0:n.auth_method))return;const e=b.s.getState().system.currentLocale;(0,g.E2)({locale:e,urlAfter:"/",redirectDelay:5e3});break;case"user.update":const o=t.data;(0,u.X6)(o);break;case"token.update":const a=(0,m.Hk)(),s=(0,m.KU)(a);a&&s.acid&&B(t);break;case"channel.update":B(t);break;case"event":"new_notification"===t.data.type&&async function(){var e;const{data:n}=await(0,w.Nn)({start_key:"",page_size:1});if(!(null===n||void 0===n||null===(e=n.items)||void 0===e?void 0:e.length))return;const t=n.items[0];switch(t.event){case k.V.GROUP_REQUEST_JOIN:{var o,a,s;const e=null===(s=null===(o=t.action)||void 0===o||null===(a=o.url)||void 0===a?void 0:a.split("/"))||void 0===s?void 0:s.pop();if(!e)return;if(!(0,h.se)(e))return;const n=(0,E.gN)(e,"wait_admin"),i=(0,U.G)(n);if(!(null===i||void 0===i?void 0:i.list))return;(0,T.JG)((0,E.gN)(e,"all")),p.dialogHandler.showToast({text:t.body,gotItText:"View members list",clickToastAction:()=>x().push("/groups/".concat(e,"?tab=members"))});break}case k.V.GROUP_APPROVED_REQUEST:{var i,r;if(!(null===(i=t.custom_data)||void 0===i?void 0:i.id))return;const e=null===(r=t.custom_data)||void 0===r?void 0:r.id,n=(0,h.se)(e);if(!(null===n||void 0===n?void 0:n.id)||"active"===n.member_status)return;n.member_count=(n.member_count||1)+1,n.member_status="active";const o=b.s.getState().account.user;if(o.user_id&&n.recent_members){const e={id:n.id,avatar:o.avatarUrl,name:o.name};n.recent_members.length>5&&n.recent_members.splice(n.recent_members.length,1),n.recent_members.unshift(e)}(0,h.uU)(n),p.dialogHandler.showToast({text:t.body,gotItText:"View group",clickToastAction:()=>x().push("/groups/".concat(e))});break}}}()}c.u.onmessage.next(t)}catch(t){}},(0,g.DD)((e=>e.ws=A))};async function B(e){var n,t,s,i;if(!(null===(n=e.data)||void 0===n?void 0:n.channel_id))return;const r=e.data.channel_id,c=(0,f.BH)(),[l,u]=await Promise.all([(0,v.BU)(c),(0,v.gV)({id:r,lan:c})]);if(!(null===(t=l.data)||void 0===t||null===(s=t.channels)||void 0===s?void 0:s.length)||!(null===(i=u.data)||void 0===i?void 0:i.id))return;const d=u.data,m=(0,a.Z)((0,o.Z)({},e),{data:{channel_id:r,name:d.name,avatar_url:d.icon}});(0,h.uU)(u.data),(0,N.TB)(l.data.channels,m)}},6811:function(e,n,t){t.d(n,{u:function(){return a}});var o=t(11914);const a={send:new o.Z(null),onmessage:new o.Z(null),onopen:new o.Z(!1),onclose:new o.Z(!1),onerror:new o.Z(null)}}}]);